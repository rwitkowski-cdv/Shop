@page "/product/create"
@page "/product/update{id:guid}"
@inject FileService _fileService
@inject IProductRepository _productRepository
@inject ICategoryRepository _categoryRepository
@inject NavigationManager _navigationManager
@inject IWebHostEnvironment _webHostEnvironment
@inject IJSRuntime _jsRuntime

@if (IsLoading)
{
    <div class="position-absolute w-75 h-75 d-flex flex-column align-items-center bg-white justify-content-center">
        <img src="/images/loading_page.gif" alt="loading" />
    </div>
}
else
{
    <div class="card shadow boarder-0 m-4">
        <div class="card-header bg-black bg-gradient ml-0 py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <h2 class="text-white py-2">@((Id ==Guid.Empty) ? "Create":"Update") Product </h2>
                </div>
            </div>
        </div>
        <div class="card-body p-4">
            <EditForm Model="_product" FormName="ProductUpsertForm" OnValidSubmit="UpsertProduct">
                <DataAnnotationsValidator/>

                <div class="border p-3 mt-4" >
                    <div class="form-floating py-3 col-12">
                        <InputText @bind-Value="_product.Name" class="form-control" id="Name" placeholder="Name" />
                        <label for="Name">Name</label>
                        <ValidationMessage For="@(() => _product.Name)" />
                    </div>

                    <div class="form-floating py-3 col-12">
                        <InputText @bind-Value="_product.SKU" class="form-control" id="SKU" placeholder="SKU" />
                        <label for="SKU">SKU</label>
                        <ValidationMessage For="@(() => _product.SKU)" />
                    </div>

                    <div class="form-floating py-3 col-12">
                        <InputText @bind-Value="_product.ImageUrl" class="form-control" id="ImageUrl" placeholder="ImageUrl" />
                        <label for="ImageUrl">ImageUrl</label>
                        <ValidationMessage For="@(() => _product.ImageUrl)" />
                    </div>

                    <div class="form-floating py-3 col-12">
                        <InputNumber @bind-Value="_product.GrossAmount" 
                           @oninput="@(g => OnGrossAmountChanged(g))"
                        class="form-control" id="GrossAmount" placeholder="GrossAmount" />
                        <label for="GrossAmount">GrossAmount</label>
                        <ValidationMessage For="@(() => _product.GrossAmount)" />
                    </div>

                    <div class="form-floating py-3 col-12">
                        <InputNumber @bind-Value="_product.NetAmount" class="form-control" id="NetAmount" placeholder="NetAmount" />
                        <label for="NetAmount">NetAmount</label>
                        <ValidationMessage For="@(() => _product.NetAmount)" />
                    </div>

                    <div class="form-floating py-3 col-12">
                        <InputNumber @bind-Value="_product.TaxAmount" class="form-control" id="TaxAmount" placeholder="TaxAmount" />
                        <label for="TaxAmount">TaxAmount</label>
                        <ValidationMessage For="@(() => _product.TaxAmount)" />
                    </div>

                    <div class="form-floating py-3 col-12">
                        <InputText @bind-Value="_product.Description" class="form-control" id="Description" placeholder="Description" />
                        <label for="Description">Description</label>
                        <ValidationMessage For="@(() => _product.Description)" />
                    </div>


                    <div class="form-check py-3 col-12">
                        <InputCheckbox @bind-Value="_product.IsAvailable" class="form-check-input" id="IsAvailable" placeholder="IsAvailable" />
                        <label class="form-check-label" for="IsAvailable">IsAvailable</label>
                        <ValidationMessage For="@(() => _product.IsAvailable)" />
                    </div>

                    <div class="form-floating py-3 col-12">
                        <InputText @bind-Value="_product.Tag" class="form-control" id="Tag" placeholder="Tag" />
                        <label for="Tag">Tag</label>
                        <ValidationMessage For="@(() => _product.Tag)" />
                    </div>

                    <div class="form-floating py-3 col-12">
                        <InputSelect @bind-Value="_product.CategoryId" class="form-select" id="Category" placeholder="CategoryId">
                            <option value="0" disabled selected>--Select a Category--</option>
                            @foreach (var category in _categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </InputSelect>
                        <label for="Category">Category</label>
                        <ValidationMessage For="@(() => _product.CategoryId)" />
                    </div>

                    <div class="form-floating py-3 col-12">
                        @if (_product.ImageUrl == null)
                        {
                            <InputFile OnChange="UploadFile" class="form-control"
                                       id="customFile" accept="image/x-png,image/jpeg"></InputFile>
                            <label for="customFile">Upload Image</label>
                        }
                        @if(_product.ImageUrl != null)
                        {
                            <div class="row pt-3">
                                <div class="col-3">
                                    <img src="@_product.ImageUrl" alt="..." alsss="img-thumbnail" />
                                 </div>
                            </div>
                            <div class="col-6 col-md-3 pt-3">
                                <i class="bi bi-trash btn btn-outline-danger" @onclick="DeleteImage">Remove Pic</i>
                            </div>
                        }
                    </div>

                    <div class="row mt-3">
                        <div class="col-6 col-md-3">
                            <button type="submit" class="btn btn-primary" form-control disabled="@IsLoading">
                                <i class="bi bi-floppy"></i> @((Id == Guid.Empty) ? "Create" : "Update")
                            </button>
                        </div>
                        <div class="col-6 col-md-3">
                            <a href="product" class="btn btn-secondary" form-control disabled="@IsLoading">
                                <i class="bi bi-arrow-left-square"></i> Back to Product List
                            </a>
                        </div>
                    </div>
                </div>
            </EditForm>
            
        </div>
    </div>
}


@code {
    [Parameter]
    public Guid Id { get; set; }
    private bool IsLoading { get; set; } = true;
    private string? _directoryPath { get; set; } 

    [SupplyParameterFromForm]
    private Product _product { get; set; } = new Product();
    private IEnumerable<Category> _categories { get; set; } = new List<Category>();

    protected override Task OnInitializedAsync()
    {
        _directoryPath = Path.Combine(_webHostEnvironment.WebRootPath, "images", "product");
        return base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firsRender)
    {
        if (firsRender)
        {
            await LoadProductAndCategories();
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadProductAndCategories()
    {
        if (Id != Guid.Empty)
        {
            _product = await _productRepository.GetProductByIdAsync(Id);
        }
        _categories = await _categoryRepository.GetAllAsync();
    }

    private async Task UpsertProduct()
    {
        IsLoading = true;

        if (_product.Id == Guid.Empty)
        {
            await _productRepository.CreateAsync(_product);
            await _jsRuntime.ShowSuccessNotification("Added Successfully");
        }
        else
        {
            await _productRepository.UpdateAsync(_product); 
            await _jsRuntime.ShowSuccessNotification("Updated Successfully");

        }
        IsLoading = false;
        _navigationManager.NavigateTo("product");
    }

    private void OnGrossAmountChanged(ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out decimal grossAmount))
        {
            _product.GrossAmount = grossAmount;
            _product.NetAmount = CalculateNetAmount(grossAmount);
            _product.TaxAmount = CalculateTaxAmount(grossAmount, _product.NetAmount);
        }
    }

    private decimal CalculateNetAmount(decimal grossAmount)
    {
        const decimal taxRate = 0.23m;
        return Math.Round(grossAmount / (1 + taxRate), 2);
    }

    private decimal CalculateTaxAmount(decimal grossAmount, decimal netAmount)
    {
        return Math.Round(grossAmount - _product.NetAmount, 2);
    }

    private async Task UploadFile(InputFileChangeEventArgs e)
    {
        IsLoading = true;

        var addImg = await _fileService.AddImageToRoot(e, _directoryPath);

        if (addImg != null)
        {
            _product.ImageUrl = addImg;
            await _jsRuntime.ShowSuccessNotification("Image Uploaded Successfully");
        }

        IsLoading = false;
    }

    private async Task DeleteImage()
    {
        await _fileService.DeleteImage(_directoryPath, _product.ImageUrl);
        _product.ImageUrl = null;
        await _jsRuntime.ShowSuccessNotification("Image Deleted Successfully");

    }

}
